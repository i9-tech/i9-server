name: üñ•Ô∏è i9 Tech Server CD - Entrega Cont√≠nua (Docker Build + Push)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-push:
    name: üê≥ Build e Publica√ß√£o da Imagem Backend
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
    
    env:
      DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
      DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}
      
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_URL: ${{ secrets.DB_URL }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
      AZURE_ACCOUNT_NAME: ${{ secrets.AZURE_ACCOUNT_NAME }}
      AZURE_CONTAINER_NAME: ${{ secrets.AZURE_CONTAINER_NAME }}
      AZURE_SAS_TOKEN: ${{ secrets.AZURE_SAS_TOKEN }}
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL }}

      RABBIT_JAVAMAIL_HOST: ${{ secrets.RABBIT_JAVAMAIL_HOST }}
      RABBIT_JAVAMAIL_PORT: ${{ secrets.RABBIT_JAVAMAIL_PORT }}
      RABBIT_JAVAMAIL_USERNAME: ${{ secrets.RABBIT_JAVAMAIL_USERNAME }}
      RABBIT_JAVAMAIL_PASSWORD: ${{ secrets.RABBIT_JAVAMAIL_PASSWORD }}
      RABBIT_TWILIO_HOST: ${{ secrets.RABBIT_TWILIO_HOST }}
      RABBIT_TWILIO_PORT: ${{ secrets.RABBIT_TWILIO_PORT }}
      RABBIT_TWILIO_USERNAME: ${{ secrets.RABBIT_TWILIO_USERNAME }}
      RABBIT_TWILIO_PASSWORD: ${{ secrets.RABBIT_TWILIO_PASSWORD }}
      RABBIT_IMAGES_HOST: ${{ secrets.RABBIT_IMAGES_HOST }}
      RABBIT_IMAGES_PORT: ${{ secrets.RABBIT_IMAGES_PORT }}
      RABBIT_IMAGES_USERNAME: ${{ secrets.RABBIT_IMAGES_USERNAME }}
      RABBIT_IMAGES_PASSWORD: ${{ secrets.RABBIT_IMAGES_PASSWORD }}
      
    steps:
      - name: üîÅ Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: ‚òï Set up Java version 
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'microsoft'
          cache: 'maven'

      - name: ‚öôÔ∏è Build with Maven
        run: mvn clean install -DskipTests
        working-directory: ./estoque-de-produtos-crud

      - name: üîê Login no Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: üè∑Ô∏è Extrair metadados (Tags/Labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=sha
            type=ref,event=branch
            latest

      - name: üöÄ Build e Push da imagem Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            DB_USER=${{ env.DB_USER }}
            DB_PASSWORD=${{ env.DB_PASSWORD }}
            DB_URL=${{ env.DB_URL }}
            TWILIO_ACCOUNT_SID=${{ env.TWILIO_ACCOUNT_SID }}
            TWILIO_AUTH_TOKEN=${{ env.TWILIO_AUTH_TOKEN }}
            AZURE_ACCOUNT_NAME=${{ env.AZURE_ACCOUNT_NAME }}
            AZURE_CONTAINER_NAME=${{ env.AZURE_CONTAINER_NAME }}
            AZURE_SAS_TOKEN=${{ env.AZURE_SAS_TOKEN }}
            AZURE_STORAGE_CONNECTION_STRING=${{ env.AZURE_STORAGE_CONNECTION_STRING }}
            JWT_SECRET=${{ env.JWT_SECRET }}
            EMAIL_USER=${{ env.EMAIL_USER }}
            EMAIL_PASSWORD=${{ env.EMAIL_PASSWORD }}
            FRONTEND_URL=${{ env.FRONTEND_URL }}
            RABBIT_JAVAMAIL_HOST=${{ env.RABBIT_JAVAMAIL_HOST }}
            RABBIT_JAVAMAIL_PORT=${{ env.RABBIT_JAVAMAIL_PORT }}
            RABBIT_JAVAMAIL_USERNAME=${{ env.RABBIT_JAVAMAIL_USERNAME }}
            RABBIT_JAVAMAIL_PASSWORD=${{ env.RABBIT_JAVAMAIL_PASSWORD }}
            RABBIT_TWILIO_HOST=${{ env.RABBIT_TWILIO_HOST }}
            RABBIT_TWILIO_PORT=${{ env.RABBIT_TWILIO_PORT }}
            RABBIT_TWILIO_USERNAME=${{ env.RABBIT_TWILIO_USERNAME }}
            RABBIT_TWILIO_PASSWORD=${{ env.RABBIT_TWILIO_PASSWORD }}
            RABBIT_IMAGES_HOST=${{ env.RABBIT_IMAGES_HOST }}
            RABBIT_IMAGES_PORT=${{ env.RABBIT_IMAGES_PORT }}
            RABBIT_IMAGES_USERNAME=${{ env.RABBIT_IMAGES_USERNAME }}
            RABBIT_IMAGES_PASSWORD=${{ env.RABBIT_IMAGES_PASSWORD }}